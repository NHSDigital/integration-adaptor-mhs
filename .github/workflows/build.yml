name: "Build"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  push:
    branches:
      - main

jobs:
  hadolint-docker:
    name: Hadolint Dockerfiles
    runs-on: ubuntu-latest
    env:
      HADOLINT_RECURSIVE: "true"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Lint dockerfiles
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5
        with:
          dockerfile: "Dockerfile"
          recursive: true

  unit-tests:
    name: "Unit Tests"
    strategy:
      matrix:
        config:
          - name: common
            path: ./common
          - name: mhs-common
            path: ./mhs/common
          - name: mhs-inbound
            path: ./mhs/inbound
          - name: mhs-outbound
            path: ./mhs/outbound
          - name: spine-route-lookup
            path: ./mhs/spineroutelookup
    uses: ./.github/workflows/test.yml
    with:
      name: ${{ matrix.config.name }}
      path: ${{ matrix.config.path }}
    secrets: inherit

  component-tests:
    name: "Component Tests"
    needs: [ hadolint-docker, unit-tests ]
    strategy:
      matrix:
        config:
          - name: "Fake Spine"
            yaml: "-f docker-compose.component.override.yml"
          - name: "SDS"
            yaml: "-f docker-compose.component.override.yml -f docker-compose.component-sds.override.yml"
    uses: ./.github/workflows/component-test.yml
    with:
      name: ${{ matrix.config.name }}
      yaml: ${{ matrix.config.yaml }}
    secrets: inherit

  generate_build_id:
    name: "Generate Build Id"
    needs: [ component-tests ]
    runs-on: ubuntu-latest
    outputs:
      build-id: ${{ steps.generate.outputs.buildId }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - id: generate
        run: |
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            GIT_BRANCH="PR"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            GIT_BRANCH="main"
          fi
          
          GIT_SHORT_SHA=$(git rev-parse --short=7 HEAD)
          BUILD_ID="${GIT_BRANCH}-${{ github.run_number }}-${GIT_SHORT_SHA}"
          echo "Generated the build tag: $BUILD_ID"
          echo "buildId=$BUILD_ID" >> $GITHUB_OUTPUT

  build-and-push-images:
    name: Build & Push Docker Images
    needs: [ generate_build_id ]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    strategy:
      matrix:
        service:
          - name: inbound
            dockerfile: docker/inbound/Dockerfile
            context: .
            ecr_repo: mhs/inbound
          - name: outbound
            dockerfile: docker/outbound/Dockerfile
            context: .
            ecr_repo: mhs/outbound
          - name: route
            dockerfile: docker/spineroutelookup/Dockerfile
            context: .
            ecr_repo: mhs/route
          - name: fake-spine
            dockerfile: integration-tests/fake_spine/Dockerfile
            context: .
            ecr_repo: fake-spine

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@8c3f20df09ac63af7b3ae3d7c91f105f857d8497
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: gp2gp_github_action_build_workflow
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@33f92af657bba1882ab79d8621debd2f6769a0c9

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226

      - name: Build and push image
        run: |
          docker build -f ${{ matrix.service.dockerfile }} -t ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.service.ecr_repo }}:${{ needs.generate_build_id.outputs.build-id }} .
          docker push ${{ secrets.DOCKER_REGISTRY }}/${{ matrix.service.ecr_repo }}:${{ needs.generate_build_id.outputs.build-id }}
